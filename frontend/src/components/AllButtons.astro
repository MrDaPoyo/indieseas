---
import Button from "./Button.astro";

import Searchbar from "./Searchbar.astro";

const queryParam = Astro.url.searchParams.get("q");
const query = queryParam ? decodeURIComponent(queryParam) : "";
let results, pagination, buttonsList;

if (query && query.trim() !== "") {
	const isColorFilter = Astro.url.searchParams.get("color") == "true";
	const colorParam = Astro.url.searchParams.get("q");
	const targetUrl = 
		new URL(Astro.url.origin + "/api/buttonSearch").href +
		"?q=" + encodeURIComponent(query) + 
		(isColorFilter ? `&color=${encodeURIComponent(colorParam)}` : "");
	
	const buttonSearchResponse = await fetch(targetUrl, {
		method: "GET",
		headers: {
			"Content-Type": "application/json",
		},
	});

	if (!buttonSearchResponse.ok) {
		throw new Error(
			`Error fetching search results: ${buttonSearchResponse.statusText} (${buttonSearchResponse.status})`
		);
	}

	results = await buttonSearchResponse.json();
	buttonsList = results.results.buttons || [];
	pagination = results.results.pagination || {
		currentPage: 1,
		totalPages: 1,
		totalButtons: buttonsList.length,
		hasPreviousPage: false,
		hasNextPage: false,
		previousPage: null,
		nextPage: null
	};
} else {
	const response = await fetch(
		new URL(
			Astro.url.origin +
				`/api/allButtons?page=${Astro.url.searchParams.get("page") || 1}`
		).href,
		{
			method: "GET",
			headers: {
				"Content-Type": "application/json",
			},
		}
	);

	if (!response.ok) {
		throw new Error(
			`Error fetching buttons: ${response.statusText} (${response.status})`
		);
	}

	const buttons = await response.json();
	buttonsList = buttons.buttons || [];
	pagination = buttons.pagination;
}

const queryMessage = query
	? `Found ${pagination.totalButtons} buttons for "${query}"!`
	: `Found ${pagination.totalButtons} buttons!`;
---

<div class="header">
	<a href="/" style="text-decoration: none; color: inherit;">
		<h1 class="mega-title" style="font-size: 3rem; margin: 0;">
			IndieSeas
		</h1>
	</a>
	<span style="margin: 5px;"></span>
	<Searchbar query={query} buttonSearch="true" />
	<style>
		.header {
			display: flex;
			flex-direction: row;
			justify-content: start;
			align-items: center;
			width: 100%;
			padding: 5px;
		}
	</style>
</div>
<hr style="margin-top: 0;" />
<div class="pagination-container">
	<span>
		<p>{queryMessage}</p>
	</span>

	<div class="pagination">
		{
			pagination.hasPreviousPage && (
				<a
					href={`?page=${pagination.previousPage}&q=${query}&color=${Astro.url.searchParams.get("color")}`}
					class="pagination-link"
				>
					Previous
				</a>
			)
		}

		<span class="page-info">
			Page {pagination.currentPage} of {pagination.totalPages}
			<span class="total-count">({pagination.totalButtons} total)</span>
		</span>

		{
			pagination.hasNextPage && (
				<a
				href={`?page=${pagination.nextPage}&q=${query}&color=${Astro.url.searchParams.get("color")}`}
					class="pagination-link"
				>
					Next
				</a>
			)
		}

		<div class="color-filter">
			<label for="color-select">Filter by color:</label>
			<select id="color-select" class="color-select">
				<option value="">All colors</option>
				<option value="red">Red</option>
				<option value="blue">Blue</option>
				<option value="green">Green</option>
				<option value="yellow">Yellow</option>
				<option value="purple">Purple</option>
				<option value="orange">Orange</option>
				<option value="black">Black</option>
				<option value="white">White</option>
				<option value="pink">Pink</option>
				<option value="brown">Brown</option>
			</select>
		</div>

		<script defer>
			document.getElementById('color-select').addEventListener('change', function() {
				const color = this.value;
				const currentUrl = new URL(window.location.href);
				const currentPage = currentUrl.searchParams.get('page') || '1';
				const existingQuery = currentUrl.searchParams.get('q');
				
				if (color) {
					window.location.href = `/buttons?color=true&q=${color}&page=${currentPage}`;
				} else if (existingQuery && existingQuery !== color) {
					window.location.href = `/buttons?q=${existingQuery}&page=${currentPage}`;
				} else {
					window.location.href = `/buttons?page=${currentPage}`;
				}
			});
		</script>

		<style>
			.color-filter {
				display: flex;
				align-items: center;
				gap: 0.5rem;
				margin-left: auto;
			}
			
			.color-select {
				padding: 0.25rem;
				border-radius: 4px;
				border: 1px solid #ccc;
			}
		</style>
	</div>
</div>

<style>
	.pagination-container {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.pagination {
		display: flex;
		gap: 1rem;
		align-items: center;
	}

	.pagination-link {
		padding: 0.25rem 0.5rem;
		border: 1px solid #ccc;
		border-radius: 4px;
		text-decoration: none;
	}

	.pagination-link:hover {
		background-color: #f0f0f0;
	}

	.total-count {
		font-size: 0.8rem;
		color: #666;
		margin-left: 0.5rem;
	}
</style>
<div class="button-container">
	{
		buttonsList.map((button: any) => (
			<Button
				src={button.src}
				image={button.image}
				links_to={button.links_to}
				alt={button.alt}
			/>
		))
	}
</div>

<style>
	.button-container {
		padding: 1rem;
		position: relative;
	}
</style>
